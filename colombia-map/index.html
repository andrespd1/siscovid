<!DOCTYPE html>
<html>
  <head>
    <title>Embedding Vega-Lite</title>

    <!-- D3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>

    <!-- Vega-Lite -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.11.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.12.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.8.0"></script>

     <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <style type="text/css">
      body { 
        font-family: oswald,'Helvetica',sans-serif;
        padding: 10px;
      }

      .panel {
        position: absolute;
        display: inline-block;
        vertical-align: top;
        background-color: #f2f3fe;
        padding: .5rem;
        margin-left: -140px;
        box-shadow: 7px 7px 20px 0 rgba(0,0,0,0.1);
      }

      .panel-heading{
        color: #B3BC3C !important;
        font-weight: 400 !important;
        font-size: 1.5rem;
        background-color: #f2f3fe !important;
        padding: 2px 5px;
      }

      .panel-body {
        font-size: 1rem;
        padding: 5px;
      }
    </style>

  </head>
  <body>
    <div id="vis"></div>
    <div class="panel panel-default">
      <div class="panel-heading"><b id="city">Colombia</b></div>
      <div class="panel-body">
        Población urbana: <b id="urban-pop">0 habs</b>
        <br />
        Densidad de población: <b id="pop-density">0 habs/km2</b>
        <br />
        % de habitantes por debajo de la línea de pobreza: <b id="poverty">0%</b>
        <br />
        % de adultos mayores de 60: <b id="olders">0%</b>
        <br />
        Capacidad hospitalaria: <b id="hospitals">0</b>
        <br />
        % de manzanas con media/alta y alta vulnerabilidad: <b id="vulnerability">22.9%</b>
      </div>
    </div>

    <script type="text/javascript">
      vega.scheme( 'basic', [ '#e8e8e8', '#a0aae3', '#3c71dc' ] );

      var spec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
        "width": 400,
        "height": 500,
        "layer": [
          {
            "data": {
              "url": "./data/departamentos.topo.json",
              "format": {
                "type": "topojson",
                "feature": "departamentos"
              }
            },
            "projection": {
              "type": "mercator"
            },
            "mark": {
              "type": "geoshape",
              "stroke": "gray"
            },
            "encoding": {
              "color": {
                "field": "properties.Casos",
                "type": "quantitative",
                "scale": {
                  "scheme": "basic"
                },
                "legend": { 
                  "title": "Casos activos",
                  "titleFontWeight": 400,
                  "direction": "horizontal",
                  "orient": "bottom",
                  "gradientLength": 400,
                  "offset": -5,
                  "format": ",.0f"
                }
              },
              "tooltip": [
                {
                  "field": "properties.departamento",
                  "type": "nominal",
                  "axis": { 
                    "title": "Departamento"
                  }
                },
                {
                  "field": "properties.Casos",
                  "type": "quantitative",
                  "axis": {
                    "title": "Casos activos",
                    "format": ",.0f"
                  }
                }
              ]
            }
          },
          {
            "data": {
              "url": "./data/ciudades.csv"
            },
            "projection": {
              "type": "mercator"
            },
            "mark":{
              "type": "circle",
              "stroke": "#B2B2B2",
              "strokeWidth": .5
            },
            "encoding": {
              "longitude": {
                "field": "longitude",
                "type": "quantitative"
              },
              "latitude": {
                "field": "latitude",
                "type": "quantitative"
              },
              "size": {
                "value": 180
              },
              "color": {
                "value": "#B3BC3C"
              },
              "opacity": {
                "value": 1
              }
            }
          },
          {
            "data": {
              "url": "./data/ciudades.csv"
            },
            "projection": {
              "type": "mercator"
            },
            "mark":{
              "type": "point"
            },
            "encoding": {
              "longitude": {
                "field": "longitude",
                "type": "quantitative"
              },
              "latitude": {
                "field": "latitude",
                "type": "quantitative"
              },
              "size": {
                "value": 450
              },
              "color": {
                "value": "#B3BC3C"
              },
              "opacity": {
                "value": 1
              }
            }
          }
        ],
        "config": {
          "style": {
            "cell": {
              "stroke": "transparent"
            }
          }
        }
      };

      vegaEmbed( '#vis', spec, { actions: false } ).then( ( { spec, view } ) => {
        view.addEventListener( 'mouseover', function( event, item ) {
          if( item !== null && item.datum !== undefined && 'city' in item.datum ) {
            var city = item.datum;
            console.log( city );

            d3.select( '#city' ).text( city.city );
            d3.select( '#urban-pop' ).text( d3.format( ',.0f' )( city[ 'urban-pop' ] ) + ' habs' );
            d3.select( '#pop-density' ).text( d3.format( ',.0f' )( city[ 'pop-density' ] ) + ' habs/km2' );
            d3.select( '#poverty' ).text( d3.format( ",.1%" )( city[ 'poverty' ] ) );
            d3.select( '#olders' ).text( d3.format( ",.1%" )( city[ 'olders' ] ) );
            d3.select( '#vulnerability' ).text( d3.format( ",.1%" )( city[ 'vulnerability' ] ) );

          }
        } );

        view.addEventListener( 'mouseout', function( event, item ) {
          if( item !== null && item.datum !== undefined && 'city' in item.datum ) {
            
            d3.select( '#city' ).text( 'Colombia' );
            d3.select( '#urban-pop' ).text( d3.format( ',.0f' )( 0 ) + ' habs' );
            d3.select( '#pop-density' ).text( d3.format( ",.0f" )( 0 ) + ' habs/km2' );
            d3.select( '#poverty' ).text( d3.format( ",.1%" )( 0 ) );
            d3.select( '#olders' ).text( d3.format( ",.1%" )( 0 ) );
            d3.select( '#vulnerability' ).text( d3.format( ",.1%" )( 0.229 ) );

          }
        } );
      } );

    </script>
  </body>
</html>